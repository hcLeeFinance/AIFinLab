[{"name":"app.R","content":"library(shiny)\r\nlibrary(zoo)\r\n\r\n# ==============================================================================\r\n# FinLab Beta Calculator (Custom Date Range Version)\r\n# 架構: 前端 JS (讀取日期 -> Proxy 抓 JSON) -> R (運算)\r\n# ==============================================================================\r\n\r\nui <- fluidPage(\r\n  titlePanel(\"財金資訊平台：CAPM Beta 係數分析\"),\r\n  \r\n  # --- JavaScript 核心邏輯 (支援自訂日期) ---\r\n  tags$head(tags$script(HTML(\"\r\n    // 透過 JS 抓取 Yahoo Finance Chart API (支援自訂日期區間)\r\n    async function fetchYahooData() {\r\n      \r\n      // 1. 讀取介面上的輸入值\r\n      const stockSym = document.getElementById('stock_sym').value;\r\n      const benchSym = document.getElementById('benchmark_sym').value;\r\n      \r\n      // 讀取 Shiny 的日期選擇器 (因為它是兩個 input，我們用 jQuery 抓取)\r\n      // Shiny 的 dateRangeInput 結構是兩個 input[type='text']\r\n      const startStr = $('#dates input:eq(0)').val(); // 格式: YYYY-MM-DD\r\n      const endStr = $('#dates input:eq(1)').val();   // 格式: YYYY-MM-DD\r\n\r\n      if (!stockSym || !benchSym || !startStr || !endStr) {\r\n        alert('請確認股票代碼與日期皆已輸入');\r\n        return;\r\n      }\r\n\r\n      // 2. 將日期轉換為 Unix Timestamp (Yahoo API 需要秒數)\r\n      const p1 = Math.floor(new Date(startStr).getTime() / 1000);\r\n      // 結束日期加 1 天 (86400秒)，確保包含當天收盤數據\r\n      const p2 = Math.floor(new Date(endStr).getTime() / 1000) + 86400;\r\n\r\n      // UI 狀態控制\r\n      $('#status_msg').text(`正在下載 ${startStr} 至 ${endStr} 的數據...`);\r\n      $('#run_btn').prop('disabled', true);\r\n      $('#run_btn').html('<i class=\\\"fa fa-spinner fa-spin\\\"><\/i> 處理中...');\r\n\r\n      // 定義抓取函數\r\n      async function getStockData(symbol) {\r\n        const baseUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/';\r\n        \r\n        // 【關鍵修改】使用 period1 與 period2 參數\r\n        const targetUrl = `${baseUrl}${symbol}?period1=${p1}&period2=${p2}&interval=1d&events=history`;\r\n        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);\r\n        \r\n        const response = await fetch(proxyUrl);\r\n        if (!response.ok) throw new Error(`無法下載 ${symbol} (HTTP ${response.status})`);\r\n        \r\n        const data = await response.json();\r\n        if (!data.chart || !data.chart.result || data.chart.result.length === 0) {\r\n          throw new Error(`Yahoo 回傳 ${symbol} 無數據`);\r\n        }\r\n        \r\n        const result = data.chart.result[0];\r\n        const timestamps = result.timestamp;\r\n        \r\n        // 處理可能缺漏的 indicators\r\n        if (!result.indicators.quote || !result.indicators.quote[0]) throw new Error('數據格式錯誤');\r\n        \r\n        const adjClose = result.indicators.adjclose ? result.indicators.adjclose[0].adjclose : null;\r\n        const close = result.indicators.quote[0].close;\r\n        \r\n        // 優先用 Adj Close，若無則用 Close\r\n        const prices = adjClose || close;\r\n        \r\n        // 轉 CSV 字串\r\n        let csvContent = 'Date,Price\\\\n';\r\n        for (let i = 0; i < timestamps.length; i++) {\r\n          if (timestamps[i] && prices[i]) {\r\n            let date = new Date(timestamps[i] * 1000);\r\n            let dateStr = date.toISOString().split('T')[0];\r\n            csvContent += `${dateStr},${prices[i]}\\\\n`;\r\n          }\r\n        }\r\n        return csvContent;\r\n      }\r\n\r\n      try {\r\n        // 平行下載\r\n        const [stockCSV, benchCSV] = await Promise.all([\r\n          getStockData(stockSym),\r\n          getStockData(benchSym)\r\n        ]);\r\n        \r\n        $('#status_msg').text('下載成功！正在進行 R 迴歸運算...');\r\n        \r\n        // 傳送給 R\r\n        Shiny.setInputValue('js_data', {\r\n          stock: stockCSV,\r\n          bench: benchCSV,\r\n          timestamp: new Date().getTime() // 強制刷新\r\n        });\r\n\r\n      } catch (error) {\r\n        console.error(error);\r\n        $('#status_msg').text('錯誤: ' + error.message);\r\n        alert('抓取失敗：' + error.message);\r\n      } finally {\r\n        $('#run_btn').prop('disabled', false);\r\n        $('#run_btn').html('<i class=\\\"fa fa-cloud-download\\\"><\/i> 執行分析 (Run)');\r\n      }\r\n    }\r\n  \"))),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      width = 3,\r\n      h4(\"參數設定\"),\r\n      hr(),\r\n      textInput(\"stock_sym\", \"個股代碼 (Symbol)\", value = \"AAPL\", placeholder = \"e.g. AAPL, 2330.TW\"),\r\n      textInput(\"benchmark_sym\", \"市場基準 (Benchmark)\", value = \"^GSPC\", placeholder = \"e.g. ^GSPC, ^TWII\"),\r\n      \r\n      # 日期選擇器 (id = dates)\r\n      dateRangeInput(\"dates\", \"資料期間\",\r\n                     start = Sys.Date() - 365,\r\n                     end = Sys.Date()),\r\n      \r\n      helpText(\"點擊按鈕後，將依照您選擇的日期區間抓取資料。\"),\r\n      \r\n      # 按鈕 (呼叫 fetchYahooData，不需傳參，直接在函數內讀 DOM)\r\n      tags$button(\r\n        id = \"run_btn\",\r\n        class = \"btn btn-primary btn-lg\",\r\n        type = \"button\",\r\n        style = \"width: 100%;\",\r\n        HTML('<i class=\"fa fa-cloud-download\"><\/i> 執行分析 (Run)'),\r\n        onclick = \"fetchYahooData()\"\r\n      ),\r\n      br(), br(),\r\n      tags$div(id = \"status_msg\", style = \"color: #e74c3c; font-weight: bold;\", \"準備就緒\")\r\n    ),\r\n    \r\n    mainPanel(\r\n      width = 9,\r\n      tabsetPanel(\r\n        # --- 分頁 1: 迴歸分析 ---\r\n        tabPanel(\"迴歸分析 (Regression)\", \r\n                 br(),\r\n                 wellPanel(\r\n                   h2(textOutput(\"beta_value\"), style = \"color: #2c3e50; font-weight: bold; margin: 0;\"),\r\n                   p(\"Model: CAPM Market Model (OLS)\")\r\n                 ),\r\n                 plotOutput(\"regPlot\", height = \"450px\"),\r\n                 hr(),\r\n                 h4(\"模型統計摘要 (Model Summary)\"),\r\n                 verbatimTextOutput(\"model_summary\")\r\n        ),\r\n        \r\n        # --- 分頁 2: 股價走勢 ---\r\n        tabPanel(\"股價走勢 (Price History)\",\r\n                 br(),\r\n                 plotOutput(\"pricePlot\", height = \"500px\")\r\n        ),\r\n        \r\n        # --- 分頁 3: 數據表格 ---\r\n        tabPanel(\"收益率數據 (Data)\", \r\n                 br(),\r\n                 dataTableOutput(\"tbl\")\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  # 1. 接收資料\r\n  market_data <- reactive({\r\n    req(input$js_data)\r\n    \r\n    tryCatch({\r\n      df_stock <- read.csv(text = input$js_data$stock, stringsAsFactors = FALSE)\r\n      df_bench <- read.csv(text = input$js_data$bench, stringsAsFactors = FALSE)\r\n      \r\n      z_stock <- zoo(df_stock$Price, order.by = as.Date(df_stock$Date))\r\n      z_bench <- zoo(df_bench$Price, order.by = as.Date(df_bench$Date))\r\n      \r\n      merged <- merge(z_stock, z_bench, all = FALSE)\r\n      names(merged) <- c(\"Stock\", \"Benchmark\")\r\n      \r\n      # 若資料過少 (例如選到假日或未來)，回傳 NULL\r\n      if(nrow(merged) < 2) stop(\"有效交易日數據不足 (可能選到了假日或區間太短)\")\r\n      \r\n      return(merged)\r\n    }, error = function(e) {\r\n      showNotification(paste(\"資料處理錯誤:\", e$message), type = \"error\")\r\n      return(NULL)\r\n    })\r\n  })\r\n  \r\n  # 2. 計算收益率\r\n  returns_data <- reactive({\r\n    req(market_data())\r\n    prices <- market_data()\r\n    ret <- diff(prices) / lag(prices, -1)\r\n    return(na.omit(ret))\r\n  })\r\n  \r\n  # 3. 建立模型\r\n  fit_model <- reactive({\r\n    req(returns_data())\r\n    dat <- returns_data()\r\n    lm(Stock ~ Benchmark, data = as.data.frame(dat))\r\n  })\r\n  \r\n  # --- Outputs ---\r\n  \r\n  output$beta_value <- renderText({\r\n    req(fit_model())\r\n    beta <- coef(fit_model())[2]\r\n    desc <- if(beta > 1.2) \"(高波動 High Volatility)\" \r\n    else if(beta > 0.8) \"(貼近大盤 Market Beta)\" \r\n    else if(beta > 0) \"(低波動 Low Volatility)\" \r\n    else \"(反向 Inverse)\"\r\n    paste0(\"Beta (β): \", format(round(beta, 4), nsmall = 4), \" \", desc)\r\n  })\r\n  \r\n  output$model_summary <- renderPrint({\r\n    req(fit_model())\r\n    summary(fit_model())\r\n  })\r\n  \r\n  output$regPlot <- renderPlot({\r\n    req(returns_data(), fit_model())\r\n    dat <- as.data.frame(returns_data())\r\n    \r\n    plot(dat$Benchmark, dat$Stock,\r\n         main = paste(\"Regression:\", input$stock_sym, \"vs\", input$benchmark_sym),\r\n         xlab = \"Market Returns\", ylab = \"Stock Returns\",\r\n         pch = 19, col = rgb(0.2, 0.4, 0.8, 0.5), las = 1, cex = 1.2)\r\n    abline(fit_model(), col = \"#e74c3c\", lwd = 3)\r\n    grid(col = \"gray\", lty = \"dotted\")\r\n    legend(\"topleft\", legend = paste(\"Beta =\", round(coef(fit_model())[2], 2)),\r\n           text.col = \"#e74c3c\", bty = \"n\", cex = 1.2)\r\n  })\r\n  \r\n  output$pricePlot <- renderPlot({\r\n    req(market_data())\r\n    prices <- market_data()\r\n    prices_norm <- prices / rep(coredata(prices)[1,], each = nrow(prices)) * 100\r\n    \r\n    par(bg = \"white\")\r\n    plot.zoo(prices_norm, plot.type = \"single\", \r\n             col = c(\"#2980b9\", \"#f39c12\"), lwd = 2.5,\r\n             xlab = \"\", ylab = \"Normalized Price (Base=100)\",\r\n             main = \"Price Performance Comparison\",\r\n             las = 1, xaxt = \"n\")\r\n    \r\n    axis.Date(1, at = index(prices_norm), format = \"%Y-%m\")\r\n    axis(2, las = 1)\r\n    legend(\"topleft\", legend = c(input$stock_sym, input$benchmark_sym), \r\n           col = c(\"#2980b9\", \"#f39c12\"), lty = 1, lwd = 2.5, bty = \"n\", cex = 1.2)\r\n  })\r\n  \r\n  output$tbl <- renderDataTable({\r\n    req(returns_data())\r\n    df <- as.data.frame(returns_data())\r\n    df_disp <- round(df * 100, 2)\r\n    colnames(df_disp) <- paste0(colnames(df_disp), \" (%)\")\r\n    df_disp <- cbind(Date = format(index(returns_data()), \"%Y-%m-%d\"), df_disp)\r\n    df_disp[order(df_disp$Date, decreasing = TRUE), ]\r\n  }, options = list(pageLength = 10, searching = FALSE))\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"},{"name":"app_old.R","content":"library(shiny)\r\nlibrary(quantmod)\r\nlibrary(zoo)\r\n\r\n# --- UI (前端介面) ---\r\nui <- fluidPage(\r\n  titlePanel(\"財金資訊平台：CAPM Beta 係數分析\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      width = 3,\r\n      h4(\"參數設定 (Parameters)\"),\r\n      hr(),\r\n      textInput(\"stock_sym\", \"個股代碼 (Symbol)\", value = \"AAPL\"),\r\n      textInput(\"benchmark_sym\", \"市場基準 (Benchmark)\", value = \"^GSPC\"),\r\n      \r\n      dateRangeInput(\"dates\", \"分析期間\",\r\n                     start = Sys.Date() - 365,\r\n                     end = Sys.Date()),\r\n      \r\n      selectInput(\"ret_type\", \"收益率計算\",\r\n                  choices = c(\"Log Return (連續複利)\" = \"log\", \r\n                              \"Arithmetic (簡單收益率)\" = \"arithmetic\")),\r\n      \r\n      hr(),\r\n      actionButton(\"run_analysis\", \"執行分析 (Run)\", \r\n                   class = \"btn-primary btn-lg\", icon = icon(\"chart-line\"))\r\n    ),\r\n    \r\n    mainPanel(\r\n      width = 9,\r\n      tabsetPanel(\r\n        # --- 修改重點：分頁 1 佈局調整 ---\r\n        tabPanel(\"迴歸分析 (Regression)\", \r\n                 br(),\r\n                 # 1. 標題與 Beta 值\r\n                 wellPanel(\r\n                   h2(textOutput(\"beta_value\"), style = \"color: #2c3e50; font-weight: bold; margin-top: 0px;\"),\r\n                   p(\"Model: Market Model Regression (Ordinary Least Squares)\")\r\n                 ),\r\n                 \r\n                 # 2. 圖表放上面 (加大高度)\r\n                 plotOutput(\"regPlot\", height = \"500px\"),\r\n                 \r\n                 br(), \r\n                 hr(), # 分隔線\r\n                 \r\n                 # 3. 統計摘要放下面 (這就是您要的 Call/Residuals/Coefficients)\r\n                 h4(\"模型統計摘要 (Model Summary)\"),\r\n                 verbatimTextOutput(\"model_summary\") \r\n        ),\r\n        \r\n        # 分頁 2: 股價走勢\r\n        tabPanel(\"股價走勢 (Price History)\",\r\n                 br(),\r\n                 plotOutput(\"pricePlot\", height = \"500px\")\r\n        ),\r\n        \r\n        # 分頁 3: 數據檢視\r\n        tabPanel(\"收益率數據 (Data Table)\", \r\n                 br(),\r\n                 downloadButton(\"downloadData\", \"下載 CSV\"),\r\n                 br(), br(),\r\n                 dataTableOutput(\"tbl\")\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# --- Server (後端邏輯) ---\r\nserver <- function(input, output) {\r\n  \r\n  # 1. 資料抓取\r\n  market_data <- eventReactive(input$run_analysis, {\r\n    withProgress(message = '連線 Yahoo Finance...', value = 0, {\r\n      tryCatch({\r\n        incProgress(0.2)\r\n        stock_xts <- getSymbols(input$stock_sym, src = \"yahoo\", \r\n                                from = input$dates[1], to = input$dates[2], \r\n                                auto.assign = FALSE)\r\n        incProgress(0.5)\r\n        bench_xts <- getSymbols(input$benchmark_sym, src = \"yahoo\", \r\n                                from = input$dates[1], to = input$dates[2], \r\n                                auto.assign = FALSE)\r\n        \r\n        merged_price <- merge(Ad(stock_xts), Ad(bench_xts), join = \"inner\")\r\n        names(merged_price) <- c(\"Stock\", \"Benchmark\")\r\n        return(na.omit(merged_price))\r\n        \r\n      }, error = function(e) {\r\n        showNotification(paste(\"下載失敗:\", e$message), type = \"error\")\r\n        return(NULL)\r\n      })\r\n    })\r\n  })\r\n  \r\n  # 2. 計算收益率\r\n  returns_data <- reactive({\r\n    req(market_data())\r\n    prices <- market_data()\r\n    if(input$ret_type == \"log\") {\r\n      ret <- diff(log(prices)) \r\n    } else {\r\n      ret <- ROC(prices, type = \"discrete\")\r\n    }\r\n    return(na.omit(ret))\r\n  })\r\n  \r\n  # 3. 建立模型\r\n  fit_model <- reactive({\r\n    req(returns_data())\r\n    dat <- returns_data()\r\n    lm(Stock ~ Benchmark, data = as.data.frame(dat))\r\n  })\r\n  \r\n  # --- Outputs ---\r\n  \r\n  output$beta_value <- renderText({\r\n    req(fit_model())\r\n    beta <- coef(fit_model())[2]\r\n    desc <- if(beta > 1.2) \"(高波動)\" else if(beta > 0.8) \"(貼近大盤)\" else \"(低波動)\"\r\n    paste0(\"Beta (β): \", format(round(beta, 4), nsmall = 4), \" \", desc)\r\n  })\r\n  \r\n  # 這裡的輸出會包含 Call, Residuals, Coefficients 等完整訊息\r\n  output$model_summary <- renderPrint({\r\n    req(fit_model())\r\n    summary(fit_model())\r\n  })\r\n  \r\n  output$regPlot <- renderPlot({\r\n    req(returns_data(), fit_model())\r\n    dat <- as.data.frame(returns_data())\r\n    \r\n    # 迴歸散佈圖\r\n    plot(dat$Benchmark, dat$Stock,\r\n         main = paste(\"Regression Analysis:\", input$stock_sym),\r\n         xlab = paste(\"Market Returns:\", input$benchmark_sym), \r\n         ylab = paste(\"Stock Returns:\", input$stock_sym),\r\n         pch = 19, col = rgb(0.2, 0.4, 0.8, 0.5),\r\n         las = 1)\r\n    abline(fit_model(), col = \"#e74c3c\", lwd = 3)\r\n    grid(col = \"gray\", lty = \"dotted\")\r\n    legend(\"topleft\", legend = paste(\"Beta =\", round(coef(fit_model())[2], 2)),\r\n           text.col = \"#e74c3c\", bty = \"n\", cex = 1.2)\r\n  })\r\n  \r\n  output$pricePlot <- renderPlot({\r\n    req(market_data())\r\n    prices <- market_data()\r\n    prices_norm <- prices / rep(coredata(prices)[1,], each = nrow(prices)) * 100\r\n    \r\n    # 乾淨白底圖表\r\n    par(bg = \"white\")\r\n    plot.zoo(prices_norm, plot.type = \"single\", \r\n             col = c(\"#2980b9\", \"#f39c12\"), lwd = 2.5,\r\n             xlab = \"\", ylab = \"Normalized Price\",\r\n             main = \"Price Performance\", las = 1, xaxt = \"n\")\r\n    axis.Date(1, at = index(prices_norm), format = \"%Y-%m\")\r\n    axis(2, las = 1)\r\n    legend(\"topleft\", legend = c(input$stock_sym, input$benchmark_sym), \r\n           col = c(\"#2980b9\", \"#f39c12\"), lty = 1, lwd = 2.5, bty = \"n\")\r\n  })\r\n  \r\n  output$tbl <- renderDataTable({\r\n    req(returns_data())\r\n    df <- as.data.frame(returns_data())\r\n    df_display <- round(df * 100, 2)\r\n    colnames(df_display) <- paste0(colnames(df_display), \" (%)\")\r\n    df_display <- cbind(Date = format(index(returns_data()), \"%Y-%m-%d\"), df_display)\r\n    df_display[order(df_display$Date, decreasing = TRUE), ]\r\n  }, options = list(pageLength = 10, searching = FALSE, lengthChange = FALSE))\r\n  \r\n  output$downloadData <- downloadHandler(\r\n    filename = function() { paste(\"beta_analysis.csv\") },\r\n    content = function(file) { write.csv(as.data.frame(returns_data()), file) }\r\n  )\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"}]
