<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinLab æˆ¿è²¸å¤§å¸« (å‹•æ…‹åˆ©ç‡ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .back-link { display: inline-block; margin-bottom: 20px; color: #0969da; text-decoration: none; font-weight: bold; }
        h1 { text-align: center; color: #1f2328; margin-top: 0; }
        
        .section-box { border: 1px solid #e1e4e8; border-radius: 8px; padding: 20px; margin-bottom: 20px; background-color: #fff; }
        .section-title { margin-top: 0; font-size: 1.1em; color: #0969da; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }

        .input-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: #555; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        .dynamic-list { list-style: none; padding: 0; margin: 0; }
        .dynamic-list li { background: #f8f9fa; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }
        .dynamic-list li:first-child { border-top: 1px solid #eee; }
        
        .btn-add { background-color: #0969da; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .btn-add:hover { background-color: #0356b6; }
        .btn-delete { background-color: #cf222e; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-left: 10px; }
        .btn-calc { width: 100%; padding: 16px; background-color: #2ea44f; color: white; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-calc:hover { background-color: #2c974b; transform: translateY(-2px); }

        .summary-box { background: #fff8c5; border: 1px solid #d4a72c; padding: 20px; border-radius: 8px; margin-top: 30px; }
        .summary-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #d4a72c; padding: 8px 0; }
        .summary-row:last-child { border-bottom: none; }
        .big-number { font-size: 1.5em; font-weight: bold; color: #d93025; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background-color: #f6f8fa; font-weight: bold; color: #333; }
        tr:hover { background-color: #f1f1f1; }
        .highlight-change { color: #d93025; font-weight: bold; background-color: #fff0f0; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <a href="../index.html" class="back-link">â† å›é¦–é </a>
    <h1>ğŸ  æˆ¿è²¸å¤§å¸« (å‹•æ…‹åˆ©ç‡ç‰ˆ)</h1>

    <div class="section-box">
        <div class="section-title">1. åˆå§‹è²¸æ¬¾æ¢ä»¶</div>
        <div class="input-row">
            <div class="input-group"><label>è²¸æ¬¾ç¸½é¡ (è¬)</label><input type="number" id="loanAmount" value="1000"></div>
            <div class="input-group"><label>åˆå§‹å¹´åˆ©ç‡ (%)</label><input type="number" id="initialRate" value="2.1" step="0.01"></div>
            <div class="input-group"><label>æœŸé™ (å¹´)</label><input type="number" id="loanYears" value="30"></div>
            <div class="input-group"><label>å¯¬é™æœŸ (å¹´)</label><input type="number" id="gracePeriod" value="0"></div>
        </div>
    </div>

    <div class="section-box">
        <div class="section-title">2. åˆ©ç‡è®Šå‹•è¨­å®š (æ¨¡æ“¬å‡é™æ¯)</div>
        <div class="input-row" style="align-items: flex-end;">
            <div class="input-group"><label>ç¬¬å¹¾å¹´é–‹å§‹è®Šå‹•</label><input type="number" id="newRateYear" placeholder="ä¾‹: 2"></div>
            <div class="input-group"><label>æ–°åˆ©ç‡ (%)</label><input type="number" id="newRateVal" placeholder="ä¾‹: 2.5"></div>
            <button class="btn-add" onclick="addRateEvent()">ï¼‹ åŠ å…¥è®Šå‹•</button>
        </div>
        <ul id="rateList" class="dynamic-list"></ul>
    </div>

    <div class="section-box">
        <div class="section-title">3. æå‰é‚„æ¬¾è¨ˆç•« (æ¨¡æ“¬çé‡‘/å¤§é¡é‚„æ¬¾)</div>
        <div class="input-row" style="align-items: flex-end;">
            <div class="input-group"><label>ç¬¬å¹¾å¹´æå‰é‚„</label><input type="number" id="prepayYear" placeholder="ä¾‹: 5"></div>
            <div class="input-group"><label>é‚„æ¬¾é‡‘é¡ (è¬)</label><input type="number" id="prepayAmount" placeholder="ä¾‹: 100"></div>
            <button class="btn-add" onclick="addPrepayEvent()">ï¼‹ åŠ å…¥é‚„æ¬¾</button>
        </div>
        <ul id="prepayList" class="dynamic-list"></ul>
    </div>

    <button class="btn-calc" onclick="calculate()">é–‹å§‹è©³ç´°é‹ç®—</button>

    <div id="resultArea" style="display:none;">
        <div class="summary-box" id="summaryHtml"></div>
        <canvas id="mortgageChart" style="margin-top:20px; max-height: 400px;"></canvas>
        
        <h3 style="margin-top:40px; border-left:5px solid #0969da; padding-left:10px;">ğŸ“… å¹´åº¦é‚„æ¬¾æ˜ç´°è¡¨</h3>
        <div style="overflow-x:auto;">
            <table id="detailTable">
                <thead>
                    <tr>
                        <th>å¹´åº¦</th>
                        <th>ç•¶å¹´åˆ©ç‡</th>
                        <th>æ¯æœˆæ‡‰ç¹³ (æœ¬+åˆ©)</th>
                        <th>å¹´åº¦é¡å¤–é‚„æ¬¾</th>
                        <th>å¹´åº•å‰©é¤˜æœ¬é‡‘</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let rateEvents = [];
    let prepayEvents = [];
    let myChart = null;

    function addRateEvent() {
        let y = parseFloat(document.getElementById('newRateYear').value);
        let r = parseFloat(document.getElementById('newRateVal').value);
        if(!y || !r) return alert("è«‹è¼¸å…¥å®Œæ•´å¹´ä»½èˆ‡åˆ©ç‡");
        rateEvents.push({ year: y, rate: r });
        rateEvents.sort((a,b) => a.year - b.year);
        document.getElementById('newRateYear').value = '';
        document.getElementById('newRateVal').value = '';
        renderLists();
    }

    function addPrepayEvent() {
        let y = parseFloat(document.getElementById('prepayYear').value);
        let amt = parseFloat(document.getElementById('prepayAmount').value);
        if(!y || !amt) return alert("è«‹è¼¸å…¥å®Œæ•´å¹´ä»½èˆ‡é‡‘é¡");
        prepayEvents.push({ year: y, amount: amt });
        prepayEvents.sort((a,b) => a.year - b.year);
        document.getElementById('prepayYear').value = '';
        document.getElementById('prepayAmount').value = '';
        renderLists();
    }

    function removeRate(idx) { rateEvents.splice(idx, 1); renderLists(); }
    function removePrepay(idx) { prepayEvents.splice(idx, 1); renderLists(); }

    function renderLists() {
        let rList = document.getElementById('rateList');
        rList.innerHTML = rateEvents.map((item, i) => `
            <li><span>ç¬¬ <b>${item.year}</b> å¹´èµ·ï¼Œåˆ©ç‡è®Šç‚º <b style="color:#d93025">${item.rate}%</b></span>
            <button class="btn-delete" onclick="removeRate(${i})">åˆªé™¤</button></li>
        `).join('');

        let pList = document.getElementById('prepayList');
        pList.innerHTML = prepayEvents.map((item, i) => `
            <li><span>ç¬¬ <b>${item.year}</b> å¹´ï¼Œé¡å¤–é‚„æ¬¾ <b style="color:#0969da">${item.amount} è¬</b></span>
            <button class="btn-delete" onclick="removePrepay(${i})">åˆªé™¤</button></li>
        `).join('');
    }

    function calculate() {
        let loanTotal = parseFloat(document.getElementById('loanAmount').value) * 10000;
        let initRate = parseFloat(document.getElementById('initialRate').value);
        let years = parseInt(document.getElementById('loanYears').value);
        let graceYears = parseInt(document.getElementById('gracePeriod').value);
        
        let totalMonths = years * 12;
        let balance = loanTotal;
        let currentRatePct = initRate;
        
        let chartLabels = [];
        let chartData = [];
        let tableRows = [];
        let totalInterestPaid = 0;
        let totalPaidReal = 0;
        
        // é—œéµä¿®æ­£ï¼šå¢åŠ ä¸€å€‹è®Šæ•¸ä¾†ç´¯è¨ˆç•¶å¹´åº¦çš„é¡å¤–é‚„æ¬¾
        let annualPrepayTrack = 0;

        document.getElementById('resultArea').style.display = 'block';

        for (let m = 1; m <= totalMonths; m++) {
            let currentYear = Math.ceil(m / 12);
            let isGracePeriod = (m <= graceYears * 12);

            // A. åˆ©ç‡è®Šå‹•
            let rateChange = rateEvents.find(e => (e.year - 1) * 12 + 1 === m);
            if (rateChange) currentRatePct = rateChange.rate;
            let monthlyRate = (currentRatePct / 100) / 12;

            // B. æå‰é‚„æ¬¾
            let prepayAmt = 0;
            // é‚è¼¯ï¼šæª¢æŸ¥æœ¬æœˆæ˜¯å¦æœ‰æå‰é‚„æ¬¾
            let prepayEvent = prepayEvents.find(e => (e.year - 1) * 12 + 1 === m);
            if (prepayEvent) {
                prepayAmt = prepayEvent.amount * 10000;
                if(balance >= prepayAmt) balance -= prepayAmt;
                else { prepayAmt = balance; balance = 0; }
                
                totalPaidReal += prepayAmt;
                // ç´¯è¨ˆåˆ°ç•¶å¹´åº¦è®Šæ•¸ä¸­
                annualPrepayTrack += prepayEvent.amount; 
            }

            // C. è¨ˆç®— PMT
            let pmt = 0;
            let interest = balance * monthlyRate;
            let principal = 0;

            if (balance > 0) {
                if (isGracePeriod) {
                    pmt = interest;
                    principal = 0;
                } else {
                    let remainingMonths = totalMonths - m + 1;
                    pmt = (balance * monthlyRate * Math.pow(1 + monthlyRate, remainingMonths)) / (Math.pow(1 + monthlyRate, remainingMonths) - 1);
                    principal = pmt - interest;
                }
            }

            balance -= principal;
            if (balance < 0) balance = 0;

            totalInterestPaid += interest;
            totalPaidReal += pmt;

            // D. ç´€éŒ„æ•¸æ“š (æ¯å¹´ç´€éŒ„æˆ–é‚„æ¸…æ™‚)
            // æ¢ä»¶ï¼šå¹´åº•(12æœˆ) OR æœ€å¾Œä¸€å€‹æœˆ OR å‰›å¥½é‚„æ¸…çš„é‚£ä¸€åˆ»
            let isYearEnd = (m % 12 === 0);
            let isLastMonth = (m === totalMonths);
            let isJustPaidOff = (balance === 0 && principal > 0); 
            // æ³¨æ„ï¼šå¦‚æœ balance å·²ç¶“æ˜¯ 0 å¾ˆä¹…äº†ï¼Œå°±ä¸é‡è¤‡ç´€éŒ„

            if (isYearEnd || isLastMonth || isJustPaidOff) {
                // é¿å…é‚„æ¸…å¾Œé‡è¤‡ç´€éŒ„å¾ˆå¤š0
                if (balance === 0 && !isJustPaidOff && !isYearEnd && !isLastMonth) continue; 
                // å¦‚æœå·²ç¶“é‚„æ¸…å¤šå¹´ï¼Œåªåœ¨å¹´åº•ç¨å¾®ç´€éŒ„ä¸€ä¸‹(é¸ç”¨)ï¼Œé€™è£¡ç°¡å–®è™•ç†ï¼š
                if (balance === 0 && chartData[chartData.length-1] === 0 && !annualPrepayTrack) {
                    // å¦‚æœä¸Šä¸€ç­†å·²ç¶“æ˜¯0ï¼Œä¸”ä»Šå¹´æ²’é‚„æ¬¾ï¼Œå°±ä¸ç”¨ä¸€ç›´è¨˜äº†ï¼Œä½†ç‚ºäº†è¡¨æ ¼å¥½çœ‹ï¼Œæˆ‘å€‘å¯ä»¥ä¿ç•™
                }

                chartLabels.push(`ç¬¬${currentYear}å¹´`);
                chartData.push(Math.round(balance / 10000));

                tableRows.push({
                    year: currentYear,
                    rate: currentRatePct,
                    monthlyPay: Math.round(pmt),
                    prepay: annualPrepayTrack, // ä½¿ç”¨ç´¯è¨ˆå€¼
                    balance: Math.round(balance / 10000)
                });

                // ç´€éŒ„å®Œå¾Œï¼Œå°‡å¹´åº¦ç´¯è¨ˆæ­¸é›¶ï¼Œæº–å‚™è¿æ¥ä¸‹ä¸€å¹´
                annualPrepayTrack = 0; 
            }
            
            if (balance <= 0 && prepayAmt === 0 && !isYearEnd && !isLastMonth) {
               // å¦‚æœå¹´ä¸­é‚„æ¸…ï¼Œè®“è¿´åœˆè·‘å®Œé€™ä¸€å¹´å†é¡¯ç¤ºçµæœæœƒæ¯”è¼ƒæ•´é½Šï¼Œæˆ–è€…ç›´æ¥è·³å‡º
            }
        }

        // æ¸²æŸ“æ‘˜è¦
        document.getElementById('summaryHtml').innerHTML = `
            <div class="summary-row"><span>åŸå§‹è²¸æ¬¾ï¼š</span><span>${(loanTotal/10000).toFixed(0)} è¬</span></div>
            <div class="summary-row"><span>ç¸½æ”¯ä»˜åˆ©æ¯ï¼š</span><span>${(totalInterestPaid/10000).toFixed(2)} è¬</span></div>
            <div class="summary-row">
                <span>ğŸ’° ç¸½å…±é‚„æ¬¾é‡‘é¡ (æœ¬+åˆ©)ï¼š</span>
                <span class="big-number">${(totalPaidReal/10000).toFixed(2)} è¬</span>
            </div>
        `;

        drawChart(chartLabels, chartData);

        // æ¸²æŸ“è¡¨æ ¼
        // éæ¿¾æ‰æœ¬é‡‘å·²ç¶“æ˜¯0ä¸”æ²’æœ‰é‚„æ¬¾å‹•ä½œçš„å¾ŒçºŒå¹´ä»½(è¦–éœ€æ±‚ï¼Œé€™é‚Šä¿ç•™å®Œæ•´åˆ—è¡¨æˆ–ç›´åˆ°é‚„æ¸…)
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„éæ¿¾ï¼šå¦‚æœé€£çºŒå…©å¹´æœ¬é‡‘éƒ½æ˜¯0ä¸”æ²’é‚„æ¬¾ï¼Œå°±ä¸é¡¯ç¤ºå¾Œé¢çš„
        let finalRows = [];
        for(let i=0; i<tableRows.length; i++) {
            finalRows.push(tableRows[i]);
            if(tableRows[i].balance === 0 && tableRows[i].prepay === 0) {
                // æª¢æŸ¥ä¸‹ä¸€è¡Œæ˜¯å¦ä¹Ÿæ˜¯0ï¼Œå¦‚æœæ˜¯å°±åœæ­¢é¡¯ç¤º
                if(i+1 < tableRows.length && tableRows[i+1].balance === 0) break;
            }
        }

        let tableHtml = finalRows.map(row => {
            let prepayText = row.prepay > 0 ? `<span class="highlight-change">+${row.prepay}è¬</span>` : "-";
            return `
                <tr>
                    <td>ç¬¬ ${row.year} å¹´</td>
                    <td>${row.rate}%</td>
                    <td><b>${row.monthlyPay.toLocaleString()}</b> å…ƒ</td>
                    <td>${prepayText}</td>
                    <td>${row.balance} è¬</td>
                </tr>
            `;
        }).join('');
        document.querySelector("#detailTable tbody").innerHTML = tableHtml;
    }

    function drawChart(labels, data) {
        const ctx = document.getElementById('mortgageChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å¹´åº•å‰©é¤˜æœ¬é‡‘ (è¬å…ƒ)',
                    data: data,
                    borderColor: '#0969da',
                    backgroundColor: 'rgba(9, 105, 218, 0.1)',
                    fill: true,
                    tension: 0.2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>

</body>
</html>